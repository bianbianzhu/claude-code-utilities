# Data Definitions

> **Authority:** This document is the single source of truth for data shapes used across the booking updates feature. Other specs reference these definitions; they do not redefine them.

## Primitive Type Definitions

Canonical representations for primitive types used in action parameters and data fields.

| Type | Representation | Format/Constraints | Notes |
|------|----------------|-------------------|-------|
| string | string | — | Free-form text |
| number | number | — | Integer or decimal |
| boolean | boolean | true / false | — |
| date | string | ISO 8601 date (YYYY-MM-DD) | — |
| datetime | string | ISO 8601 datetime, UTC | e.g., 2024-03-15T14:30:00Z |
| time | string | HH:MM (24-hour) | Local venue time unless otherwise specified |
| enum | string | one of defined enum_values | — |

---

## Atomic Action

Represents a single API operation transformed from OpenAPI with enhanced metadata.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| action_id | string | yes | unique, matches source operationId | Identifier derived from OpenAPI operationId (preserves original format) |
| name | string | yes | max 50 chars | Human-readable action name |
| description | string | yes | max 500 chars | LLM-friendly description with usage context |
| parameters | list[ActionParameter] | yes | — | Parameters the action accepts |
| safety_tier | enum | yes | normal / high_risk / blocked | Risk classification |
| reversible | boolean | yes | — | Whether action can be rolled back |
| compensation_action_id | string | no | references action_id | Action to call for rollback (if reversible) |
| examples | list[string] | no | max 3 | Example natural language triggers |

## Action Parameter

Describes a single parameter for an atomic action.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| name | string | yes | snake_case | Parameter name |
| type | enum | yes | string / number / boolean / date / datetime / time / enum | Data type |
| required | boolean | yes | — | Whether parameter must be provided |
| description | string | yes | max 200 chars | LLM-friendly description |
| enum_values | list[string] | no | — | Valid values if type is enum |
| default | any | no | matches type | Default value if not provided |

## Execution Plan

Represents a plan generated by the LLM Planner awaiting user confirmation or execution.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| plan_id | string | yes | UUID v4 | Unique plan identifier |
| session_id | string | yes | — | Chat session this plan belongs to |
| user_id | string | yes | — | User who created the plan |
| intent_summary | string | yes | max 200 chars | Human-readable summary of what plan does |
| status | enum | yes | pending_confirmation / confirmed / executing / completed / failed / rolled_back | Current state |
| actions | list[PlannedAction] | yes | min 1 | Ordered list of actions to execute |
| created_at | datetime | yes | UTC | When plan was generated |
| confirmed_at | datetime | no | UTC | When user confirmed |
| completed_at | datetime | no | UTC | When execution finished |
| failure_reason | string | no | — | Error description if status is failed |
| rollback_report | RollbackReport | no | — | Details if rollback was performed |
| blocking_prompt | string | no | — | If set while `executing`, indicates plan is paused awaiting user response to this question |

## Planned Action

A single action within an execution plan.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| step_number | integer | yes | starts at 1 | Execution order |
| action_id | string | yes | references Atomic Action | Which action to execute |
| parameters | map[string, any] | yes | — | Parameter values (may contain placeholders) |
| safety_tier | enum | yes | normal / high_risk | Inherited from action definition |
| executed | boolean | yes | default false | Whether step has been executed |
| result | ActionResult | no | — | Outcome after execution |

## Action Result

Outcome of executing a single action.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| success | boolean | yes | — | Whether action completed successfully |
| response_data | map[string, any] | no | — | Data returned by the action (for placeholder resolution) |
| error_type | enum | no | bad_request / unauthorized / not_found / conflict / rate_limited / server_error / timeout | Error classification if failed |
| error_message | string | no | — | Human-readable error description |

## Rollback Report

Details of rollback attempt after execution failure.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| triggered_by_step | integer | yes | — | Which step's failure triggered rollback |
| actions_reversed | list[integer] | yes | — | Step numbers successfully rolled back |
| actions_failed_to_reverse | list[ReversalFailure] | no | — | Steps that could not be rolled back |
| irreversible_actions_completed | list[integer] | no | — | Steps that were irreversible and remain in effect |
| manual_recovery_steps | list[string] | no | — | Guidance for user to manually recover |

## Reversal Failure

Details when a compensation action fails.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| step_number | integer | yes | — | Which step failed to reverse |
| reason | string | yes | — | Why compensation failed |

## Action Metadata Overlay

Configuration that enhances a raw OpenAPI operation with LLM-friendly metadata and safety information. Applied during Action Transformer processing.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| operation_id | string | yes | matches OpenAPI operationId | Which operation this overlay enhances |
| iq_enabled | boolean | yes | — | Whether this operation is exposed to the LLM planner |
| llm_description | string | no | max 500 chars | Natural language description including when to use; overrides OpenAPI description |
| parameter_allowlist | list[string] | no | — | Which optional parameters to expose (required params always included) |
| safety_tier | enum | yes | normal / high_risk / blocked | Risk classification |
| reversible | boolean | yes | — | Whether action can be rolled back |
| compensation_operation_id | string | no | references another operation_id | Operation to call for rollback (required if reversible=true) |
| examples | list[string] | no | max 3 | Example natural language triggers for few-shot context |

## Booking Search Query

Input for fuzzy booking search when booking reference is not found in chat context.

> **Note:** Field requirements represent what this service needs to support search; actual ROLLER API parameters may differ. Mapping is implementation detail.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| search_text | string | yes | max 200 chars | User's search terms (guest name, booking reference fragment, etc.) |
| venue_id | string | yes | — | Scope search to user's venue |
| date_range_start | date | no | — | Optional filter: bookings on or after this date |
| date_range_end | date | no | — | Optional filter: bookings on or before this date |
| max_results | integer | no | default bounded (small) | Limit number of candidates returned |

## Booking Summary

Minimal booking representation for disambiguation UI when multiple bookings match a fuzzy search.

> **Note:** Fields represent what is needed for disambiguation; actual ROLLER API response may include additional fields that are ignored. Exact field mapping is implementation detail.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| booking_id | string | yes | — | Canonical booking identifier (used for downstream actions) |
| guest_name | string | yes | — | Primary guest name for display |
| booking_date | date | yes | — | Date of the booking |
| booking_time | time | no | HH:MM local venue time | Start time if applicable |
| party_size | integer | no | — | Number of guests |
| status | string | no | — | Booking status (e.g., confirmed, pending) |
| display_label | string | no | — | Pre-formatted label for UI if provided by API |

## Enums

### Plan Status

| Value | Meaning |
|-------|---------|
| pending_confirmation | Plan generated, awaiting user confirmation |
| confirmed | User confirmed, waiting in queue |
| executing | Currently being executed |
| completed | All actions executed successfully |
| failed | Execution failed (rollback may have occurred) |
| rolled_back | Execution failed and rollback completed |

### Safety Tier

| Value | Meaning |
|-------|---------|
| normal | Standard action, no special handling |
| high_risk | Highlighted in confirmation UI; future: may require extra confirmation |
| blocked | Never exposed to LLM; cannot be executed through this system |

### Error Type (Action-Level)

Used within action execution results.

| Value | Meaning |
|-------|---------|
| bad_request | 400 - Invalid parameters |
| unauthorized | 401/403 - Auth failure |
| not_found | 404 - Resource doesn't exist |
| conflict | 409 - Concurrent modification detected |
| rate_limited | 429 - Too many requests |
| server_error | 5xx - ROLLER service error |
| timeout | Request timed out |

### Service Error Type

Used at the IQ integration boundary for service-level errors (distinct from action-level errors above).

| Value | Meaning |
|-------|---------|
| invalid_input | Request cannot be processed (malformed, missing required fields) |
| service_unavailable | Service temporarily cannot handle requests |
| auth_required | User authentication is invalid or expired |

## Service Error

Service-level error payload returned at the IQ integration boundary.

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| error_type | ServiceErrorType | yes | — | Classification of the error |
| message | string | yes | max 500 chars | Human-readable error description |
