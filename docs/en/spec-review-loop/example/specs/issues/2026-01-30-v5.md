# Spec Review: Thresholded Issues

Identified by Codex analysis on 2026-01-29.

---

## Critical Issues

### Issue 1: Missing interface for answering `blocking_prompt` and resuming execution

**Severity**: Critical

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration)

**Guide Rule ID**: G8

**Problem**: The spec introduces a paused execution mode (`blocking_prompt` while `executing`) but does not define how the IQ orchestrator supplies the user’s answer to resume the already-running plan. Without a defined inbound contract/flow for “submit answer / resume”, implementing the core execution loop and conversation handoff is ambiguous.

**Evidence**:

- Spec: “Execution pauses until user responds (plan remains in `executing` status)”.
- Spec: “Execution may pause for user input while remaining in `executing` status; when paused, `blocking_prompt` is set with the question awaiting response; cleared when user responds and execution resumes”.
- Spec: “If `executing` with `blocking_prompt` set: the question awaiting user response”.
- Guide (G8): “**Check:** When a component interacts with others, does the spec declare what data is passed and when?”

**Impact**: Implementers (and the IQ orchestrator) must guess whether the next user message routes to `Handle Booking Update Request`, whether `plan_id` must be included, how to disambiguate “new request” vs “answer”, and how authorization is validated for that continuation. This can lead to stuck executions, misrouted messages, or incorrect plan continuation.

**Suggested Fix**: Add an explicit inbound interface for continuation, e.g.:
- `Inbound: Submit Blocking Prompt Answer` with inputs `{ plan_id, session_id, user_message, user_auth_token }`, and define semantics (only allowed when status=`executing` and `blocking_prompt` present; clears `blocking_prompt`; resumes execution).
- Clarify routing rules: how IQ decides whether a user message is a new request vs an answer to an active `blocking_prompt` (including what happens if there are multiple active plans).

---

### Issue 2: Contradiction between “post-confirmation immutability” and executor “adjust sequence”

**Severity**: Critical

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: Action Executor

**Guide Rule ID**: G10

**Problem**: The spec states that a confirmed plan must not be structurally modified post-confirmation, but also states the executor can change action sequencing during execution (“adjust sequence”). This is a direct contradiction in a core flow: whether the executor is bound to the confirmed `actions` list/order or permitted to deviate.

**Evidence**:

- Spec: “LLM can self-correct: wrong params, unexpected response, adjust sequence”.
- Spec: “**Post-confirmation immutability:** The confirmed plan's actions/parameters may not be structurally modified post-confirmation (only data gaps filled)”.
- Guide (G10): “**Check:** If the component has lifecycle/status/state, are valid transitions and invariants explicitly documented?”

**Impact**: Implementation must guess which invariant to honor. Allowing sequence changes without re-confirmation can violate user expectations (“confirm once”), and disallowing sequence changes may prevent the self-correction behavior the spec claims is in-scope. Either choice risks incorrect behavior and hard-to-debug production incidents.

**Suggested Fix**: Make the rule explicit and enforceable:
- Option A (strict): Executor must execute the confirmed `actions` in order; “self-correct” is limited to parameter formatting/placeholder resolution and retrying the same step, not reordering or substituting steps.
- Option B (flexible): Executor may propose a structural change (reorder/add/remove steps) but must transition back to `pending_confirmation` (new plan version) and require user re-confirmation before continuing.

---

## High Priority Issues

### Issue 3: IQ integration request/response contracts are not centralized and error enums conflict with existing error types

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration)

**Guide Rule ID**: G9

**Problem**: The spec defines service-level response variants and enums inline (plan vs clarification vs error), but these shapes are not defined in the centralized contracts document. Additionally, the “Error response” enum differs from the centralized `Error Type` enum used for tool execution, which invites type drift and integration mismatches.

**Evidence**:

- Spec: “**Output:** One of:
  - **Plan response:** ExecutionPlan (see [data-definitions.md](contracts/data-definitions.md)) with status `pending_confirmation`
  - **Clarification response:** Question text (string) to relay to user
  - **Error response:** Error type (enum: invalid_input / service_unavailable / auth_required) + message”.
- Contracts: “| error_type | enum | no | bad_request / unauthorized / not_found / conflict / rate_limited / server_error / timeout | Error classification if failed |”.
- Guide (G9): “**Check:** Are data shapes declared in `specs/contracts/` (or `specs/interfaces.md`) rather than scattered in multiple specs?”

**Impact**: IQ↔service integration will require guessing payload shape (e.g., discriminators, fields), and engineers may incorrectly reuse tool-level `error_type` where service-level errors are intended (or vice versa). This increases rework risk and can produce incorrect client behavior.

**Suggested Fix**: Add centralized contracts for the integration boundary, e.g. extend `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` with:
- `BookingUpdateRequest` (inputs for handle/confirm/status/answer flows)
- `BookingUpdateResponse` as a discriminated union (`type: plan | clarification | error`)
- `ServiceErrorType` (and mapping rules to tool-level `Error Type`, if both are needed)

---

### Issue 4: `ExecutionPlan.user_id` is required but the service interface does not supply it and token handling is “opaque”

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` > Section: Execution Plan

**Guide Rule ID**: G8

**Problem**: The centralized `Execution Plan` contract requires `user_id`, but the inbound interface provides “user auth token (opaque, passed through)” without defining how `user_id` is obtained. This leaves an implementer to guess whether to decode the token, call an identity endpoint, or omit/encrypt the field.

**Evidence**:

- Contracts: “| user_id | string | yes | — | User who created the plan |”.
- Spec: “Input: User message (string), session_id (string), user auth token (opaque, passed through)”.
- Guide (G8): “**Check:** When a component interacts with others, does the spec declare what data is passed and when?”

**Impact**: Authorization checks (e.g., “only the creator can view/confirm the plan”) and audit/observability correlation can’t be implemented reliably without a defined source of `user_id`. Making assumptions here is likely to cause later rework and security bugs.

**Suggested Fix**: Choose and specify one approach:
- Require `user_id` as an explicit input from IQ (derived by IQ from its authenticated session), or
- Specify how this service derives `user_id` (e.g., token introspection capability or a ROLLER “current user” lookup), and document failure handling when identity cannot be resolved.

---

## Summary

| ID | Issue | Severity | Location | Guide Rule | Status |
| --- | ------- | -------- | ----------------------- | ---------- | ------ |
| 1 | Missing interface for answering `blocking_prompt` and resuming execution | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Open |
| 2 | Contradiction between “post-confirmation immutability” and executor “adjust sequence” | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G10 | Open |
| 3 | IQ integration request/response contracts are not centralized and error enums conflict with existing error types | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Open |
| 4 | `ExecutionPlan.user_id` is required but the service interface does not supply it and token handling is “opaque” | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` | G8 | Open |

---

## Files Reviewed

Checklist of specs reviewed (from `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md`):

- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/questions-and-answers.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`
