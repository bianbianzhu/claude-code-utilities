# Spec Verification Report

Verified by Codex on 2026-01-29.

---

## Summary
| ID | Issue | Severity | Location | Guide Rule | Status (Fixed/Partial/Missing/Declined/Declined-Accepted) | Notes |
|----|-------|----------|----------|------------|--------------------------------------------------|-------|
| 1 | Langfuse tracing can leak PII/auth tokens without a required redaction contract | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G11 | Declined-Accepted | No spec-level redaction policy added; accepted due to existing Langfuse redaction pipeline. |
| 2 | Execution can prompt the user mid-run, but plan lifecycle/state model has no “waiting for user” (and confirmation invariants become unclear) | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G10 | Fixed | Added `blocking_prompt` to centralized plan contract + clarified pause semantics/invariants. |
| 3 | Booking domain contracts are missing (blocking fuzzy search + placeholder resolution from being implementation-ready) | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Declined-Accepted | Deferred until external ROLLER API contract is confirmed; `map[string, any]` is intentional design flexibility. |
| 4 | The external interface to this service (chat request, plan confirmation, status polling/updates) is not specified | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Declined-Accepted | Prose descriptions with `ExecutionPlan` references satisfy behavioral contract requirements; formal envelope tables deferred to planning phase. |

## Detailed Findings

### Issue 1: Langfuse tracing can leak PII/auth tokens without a required redaction contract

**Severity**: Critical

**Status**: Declined-Accepted

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Observability; Constraints > Security; Constraints > Privacy/PII

**Guide Rule ID**: G11

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**: Declined by implementer; accepted in feedback review

**Assessment**: See Feedback Review

**Remaining Work** (if any): None

### Issue 2: Execution can prompt the user mid-run, but plan lifecycle/state model has no “waiting for user” (and confirmation invariants become unclear)

**Severity**: Critical

**Status**: Fixed

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: State Model > Invariants; Service Interface (IQ Integration) > Inbound: Get Plan Status

**Guide Rule ID**: G10

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**:
- Added `blocking_prompt` to `ExecutionPlan` as a centralized contract field (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`).
- Clarified that execution pauses-within-`executing` is represented by `blocking_prompt` being set/cleared, and separated post-confirmation immutability as its own invariant (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`).
- Updated status polling contract to return the pending question when `blocking_prompt` is set (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`).

**Assessment**: Fully addressed

**Remaining Work** (if any): None

### Issue 3: Booking domain contracts are missing (blocking fuzzy search + placeholder resolution from being implementation-ready)

**Severity**: High

**Status**: Declined-Accepted

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Data Definitions; Open Questions

**Guide Rule ID**: G9

**Problem**: Booking entity/search contracts and canonical placeholder keys remain undefined in centralized contracts. The contracts still rely on untyped maps for action `parameters` and `response_data`, leaving the shared shapes required for fuzzy search + placeholder resolution to be guessed during implementation.

**Evidence**:
- `PlannedAction.parameters` remains `map[string, any]` and `ActionResult.response_data` remains `map[string, any]` (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`).
- The design spec still treats booking search response format as unknown and defers it in Open Questions (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`).

**Impact**: High risk of cross-module drift and fragile placeholder resolution, because downstream components (planner/executor/UI) have no shared, normalized contract for "what booking candidates look like" or "what fields a step must return to satisfy later placeholders".

**Suggested Fix**: Add minimal internal, normalized contracts in `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` (or a new contracts file) that are explicitly "post-adapter shapes" (not the external raw API), covering:
- Minimal booking disambiguation fields used by fuzzy search (e.g., stable id + display label + match_reason/confidence + a small set of optional identifiers).
- A canonical placeholder key inventory for each MVP action's `response_data` (keys only + meaning), so later steps can reference them without guessing.

**What Changed**: Declined by implementer; human reviewer agrees with the feedback

**Assessment**: See Feedback Review

**Remaining Work** (if any): None

### Issue 4: The external interface to this service (chat request, plan confirmation, status polling/updates) is not specified

**Severity**: High

**Status**: Declined-Accepted

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration)

**Guide Rule ID**: G8

**Problem**: The interface section is clearer and more concrete than before, but it still does not fully declare the cross-module boundary as a set of contract-referenced payloads with unambiguous MVP behavior. In particular, outbound status updates still have "mechanism TBD", and the inbound/outbound payloads are described in prose rather than as centralized request/response shapes.

**Evidence**:
- "Outbound: Status Updates" still leaves integration mechanism as "Callback or event (integration pattern TBD with IQ team)" (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`).
- The section references `ExecutionPlan` (good), but does not define minimal boundary request/response contract shapes (e.g., `HandleBookingUpdateRequest/Response`, `ConfirmPlanRequest/Response`, `GetPlanStatusRequest/Response`) in `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`.

**Impact**: Integration still requires assumptions about:
- Whether MVP relies solely on polling vs also requires subscription/callback wiring.
- The precise payload envelope the IQ orchestrator should send/receive (beyond the plan object).

**Suggested Fix**: Choose one minimal MVP boundary and codify it end-to-end:
- If MVP is polling-only: explicitly defer outbound status updates (and remove/mark the outbound section as deferred).
- Add centralized boundary contracts (tables) for request/response shapes that reference `ExecutionPlan` and include error cases and the `blocking_prompt` behavior.

**What Changed**: Declined by implementer; human reviewer agrees with the feedback

**Assessment**: See Feedback Review

**Remaining Work** (if any): None

## Feedback Review (if applicable)

### Issue 1: Langfuse PII/token redaction
- **Implementer's Reasoning**: Existing Langfuse setup has a data cleaning pipeline that handles PII/token redaction; spec-level allowlist/denylist policy is not required unless the pipeline proves insufficient.
- **Assessment**: Valid
- **Response**:
  - Accepted - removed from tracking

### Issue 3: Booking domain contracts missing
- **Implementer's Reasoning**: The external ROLLER API contract is explicitly unknown (Open Questions: "What's the exact format of booking search API response?"). Defining normalized booking contracts now would require speculating about external shapes that may change. The `map[string, any]` typing for `parameters` and `response_data` is intentional design flexibility — not a gap. G9 requires centralized contracts for known shared shapes; the booking search response shape is not yet known. When the external API is confirmed, the planning phase can define concrete internal contracts. This is the correct sequencing per the dual-layer contracts architecture: spec layer defines abstract behavioral contracts, planning layer generates implementation types when external dependencies are resolved.
- **Assessment**: Valid
- **Response**:
  - Accepted - removed from tracking

### Issue 4: External service interface incomplete
- **Implementer's Reasoning**: The spec describes inputs/outputs for each inbound interface in prose with references to the centralized `ExecutionPlan` contract. Per SPEC_GENERATION_GUIDE, behavioral contracts describe "Input → output → side effects" — this is satisfied. Adding formal request/response envelope tables would approach implementation-level detail (method signatures, error response envelopes) that the spec intentionally avoids. The current descriptions are sufficient for an implementer to understand the boundary; exact payload shapes are determined during planning when the actual IQ integration contract is established.
- **Assessment**: Valid
- **Response**:
  - Accepted - removed from tracking

## New Issues (Regressions)

None detected in the applied fixes (no new G1–G11 violations introduced by the changes made since v2).

## Completion Status

<promise>SPEC_APPROVED</promise>
- All issues resolved or accepted
