# Spec Review: Thresholded Issues

Identified by Codex analysis on 2026-01-29.

---

## Critical Issues

### Issue 1: Get Plan Status Missing AuthZ Context (IDOR Risk)

**Severity**: Critical

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration) → Inbound: Get Plan Status

**Guide Rule ID**: G8

**Problem**: The “Get Plan Status” integration contract does not require `user_id` or a user auth token, unlike other inbound methods that enforce plan ownership. This leaves the authorization model undefined at the polling boundary and creates an insecure-by-default shape (plan status becomes readable with `plan_id` alone).

**Evidence**:

- Spec text:
  > “### Inbound: Get Plan Status  
  > - **Trigger:** Client polls for execution status  
  > - **Input:** plan_id (string, UUID)”

- Guide rule text:
  > “### G8 — Cross-Module Interfaces Declared  
  > **Check:** When a component interacts with others, does the spec declare what data is passed and when?”

**Impact**: A caller that can obtain or guess a `plan_id` could read execution status and payloads (including intent summaries, booking-related details, and failure/rollback info), causing cross-user data exposure and undermining the trust boundary with IQ.

**Suggested Fix**:
- Update “Get Plan Status” input to include `user_id` + user auth token (or explicitly declare it as IQ-internal only and still require caller identity), and specify the ownership check (`user_id` must match plan creator).
- Add explicit error cases for auth failure (403) and missing/invalid auth (401), matching the other inbound methods.

---

## High Priority Issues

### Issue 2: Queue Failure Recovery Contradicts Confirm Plan Idempotency and State Model

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Cross-Module Interfaces → LLM Planner → Queue Manager; Service Interface (IQ Integration) → Inbound: Confirm Plan; State Model

**Guide Rule ID**: G10

**Problem**: The spec says a plan can be “re-confirmed” if queueing fails, but the Confirm Plan contract states re-confirm is a no-op (“returns current status”), and the state model does not include a state or field to represent “confirmed but not queued/enqueue failed”. This creates undefined behavior for a common failure mode (queue insertion failure).

**Evidence**:

- Spec text (queue failure handling):
  > “### LLM Planner → Queue Manager  
  > - **Error handling:** If queue fails, report to user; plan can be re-confirmed”

- Spec text (idempotency definition):
  > “- **Idempotency:** Confirming an already-confirmed plan returns current status (no error)”

- Guide rule text:
  > “### G10 — State Transitions Defined  
  > **Check:** If the component has lifecycle/status/state, are valid transitions and invariants explicitly documented?”

**Impact**: Implementers must guess whether “re-confirm” should re-enqueue, whether a second confirm is allowed to change state, and how to represent/communicate queue failures. This can lead to stuck plans (confirmed forever), duplicate enqueues, or inconsistent client behavior.

**Suggested Fix**:
- Define queue insertion semantics and a representation for enqueue failure (e.g., add `enqueue_failed` status, or add `enqueue_error` field + invariant).
- Clarify Confirm Plan behavior when status is `confirmed` but not enqueued (idempotent re-enqueue vs no-op), and update the state model transitions accordingly.

---

### Issue 3: Metadata Overlay Field Name Drift vs Central Contract

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: Action Transformer → Transformation Rules; `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` > Section: Action Metadata Overlay

**Guide Rule ID**: G9

**Problem**: The Action Transformer spec uses a metadata key name that differs from the centralized contract. This is cross-spec contract drift in a core configuration surface (which endpoints are exposed to the LLM).

**Evidence**:

- Spec text:
  > “1. **Endpoint Selection:** Only endpoints marked as `iq-enabled: true` in metadata are transformed”

- Contract text:
  > “| iq_enabled | boolean | yes | — | Whether this operation is exposed to the LLM planner |”

- Guide rule text:
  > “### G9 — Centralized Contracts  
  > **Check:** Are data shapes declared in `specs/contracts/` (or `specs/interfaces.md`) rather than scattered in multiple specs?”

**Impact**: Implementers may build the overlay parser and author overlay files inconsistently (`iq-enabled` vs `iq_enabled`), leading to endpoints accidentally not exposed (or exposed) and unpredictable planner behavior.

**Suggested Fix**:
- Standardize on the contract field name `iq_enabled` everywhere (including prose and any future examples).
- If backward compatibility is needed, explicitly specify a mapping/aliasing strategy and state which is canonical.

---

### Issue 4: Central Contract Type System Is Internally Inconsistent (`time` Undefined)

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` > Section: Action Parameter; Booking Summary

**Guide Rule ID**: Checklist item — “Data definitions are sufficient to generate shared types during planning phase”

**Problem**: The contract introduces a `time` type in `BookingSummary.booking_time`, but the contract’s enumerated primitive types (used for action parameters) do not include `time`, and there is no definition/constraint for `time` (e.g., ISO 8601 time-only string). This forces the planning layer to guess how to model/validate time-only values.

**Evidence**:

- Contract text (primitive type list):
  > “| type | enum | yes | string / number / boolean / date / datetime / enum | Data type |”

- Contract text (uses `time` anyway):
  > “| booking_time | time | no | — | Start time if applicable |”

- Guide checklist text:
  > “- [ ] Data definitions are sufficient to generate shared types during planning phase”

**Impact**: Type generation and validation can drift (some components treat `time` as string, others as datetime), causing serialization bugs and cross-module contract test failures during integration.

**Suggested Fix**:
- Define `time` explicitly (e.g., as `string` with constraint “HH:MM(:SS) local venue time” or “ISO 8601 time”) and/or add `time` to the canonical primitive type list with constraints.
- Ensure the same representation is used consistently across all data shapes that include time-only fields.

---

## Summary

| ID | Issue | Severity | Location | Guide Rule | Status |
| --- | ------- | -------- | ----------------------- | ---------- | ------ |
| 1 | Get Plan Status Missing AuthZ Context (IDOR Risk) | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Open |
| 2 | Queue Failure Recovery Contradicts Confirm Plan Idempotency and State Model | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G10 | Open |
| 3 | Metadata Overlay Field Name Drift vs Central Contract | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Open |
| 4 | Central Contract Type System Is Internally Inconsistent (`time` Undefined) | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` | Checklist | Open |

---

## Files Reviewed

- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/questions-and-answers.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`

