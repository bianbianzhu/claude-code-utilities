# Spec Review: Thresholded Issues

Identified by Codex analysis on 2026-01-29.

---

## Critical Issues

### Issue 1: Langfuse tracing can leak PII/auth tokens without a required redaction contract

**Severity**: Critical

**Status**: Deferred (Known)

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Observability; Constraints > Security; Constraints > Privacy/PII

**Guide Rule ID**: G11

**Problem**: The specs simultaneously require rich tracing (including tool parameters/responses) and require that PII/auth tokens are not logged, but do not define a concrete, enforceable redaction/allowlist policy for what can be attached to Langfuse traces. This creates a high likelihood of leaking guest PII (email/phone) and/or auth headers in observability data.

**Evidence**:

- Guide (G11): “**Check:** If the component handles user data, are sensitivity, redaction, and retention rules stated?” (`/Users/tianyi.li/Dev/agent-actions-mvp/./references/SPEC_GENERATION_GUIDE.md`)
- Spec (PII + no token logging): “**Sensitive data:** Guest contact details (email, phone) are PII” and “**Auth tokens:** Passed through, never logged or stored” (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md`)
- Spec (trace parameters/responses): “Tool Call | Action ID, parameters, response, latency, success/failure” (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`)

**Impact**: If implemented as written, observability may capture PII and credentials, creating a security/privacy incident risk and potentially violating policy/compliance requirements. It also blocks safe implementation decisions (engineers must guess what to log vs redact).

**Suggested Fix**:

- Add an explicit "Observability Redaction Policy" section (authoritative) defining:
  - A denylist of sensitive keys/headers (e.g., `authorization`, `cookie`, `email`, `phone`, `token`, etc.)
  - A per-event allowlist of fields permitted in Langfuse metadata for: LLM calls, tool calls, and responses
  - Whether tool parameters/responses are logged in full, partially, hashed, or replaced with structured summaries
  - Retention alignment statement for Langfuse vs session retention (and what happens when they differ)

**Resolution Note**: Deferred — existing Langfuse setup has a data cleaning pipeline that handles PII/token redaction. Will revisit if the existing pipeline proves insufficient for this service's tracing needs.

---

### Issue 2: Execution can prompt the user mid-run, but plan lifecycle/state model has no “waiting for user” (and confirmation invariants become unclear)

**Severity**: Critical

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: Action Executor > Execute Plan; State Model > Plan Status Transitions; Invariants

**Guide Rule ID**: G10

**Problem**: The design states execution can prompt the user for missing critical information, but the plan status model and invariants do not define how an executing plan transitions into a “waiting for user input” state (or whether execution is allowed to change parameters/actions post-confirmation). This is both a lifecycle ambiguity and a user-consent/security ambiguity.

**Evidence**:

- Guide (G10): “**Check:** If the component has lifecycle/status/state, are valid transitions and invariants explicitly documented?” (`/Users/tianyi.li/Dev/agent-actions-mvp/./references/SPEC_GENERATION_GUIDE.md`)
- Spec (mid-execution prompt): “LLM can prompt user if missing critical information not in context” (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`)
- Spec (current status set): “status | enum | … pending_confirmation / confirmed / executing / completed / failed / rolled_back” (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`)

**Impact**: Queue manager/executor/mobile experience cannot be implemented without guessing:
- Does the job pause? For how long? What status should the user see?
- Is the original confirmed plan still valid after the user supplies new info?
- When (if ever) is re-confirmation required before further mutations?

**Suggested Fix**:

- Extend `Plan Status` with an explicit state for user input (e.g., `awaiting_user_input`) and document transitions/invariants.
- Specify a hard rule for post-confirmation changes:
  - Either: execution may only fill in placeholders within the confirmed action list (no adding/removing/reordering actions), or
  - If actions/parameters materially change: generate a new plan that returns to `pending_confirmation`.

**Implementation Note**: May leverage LangGraph's built-in interrupt mechanism for pause/resume logic rather than building custom state management. During development, will reference latest LangGraph documentation (via context7) to evaluate fit. The spec may not need to define custom lifecycle states if the framework handles this natively.

---

## High Priority Issues

### Issue 3: Booking domain contracts are missing (blocking fuzzy search + placeholder resolution from being implementation-ready)

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: LLM Planner > Plan Generation; Data Placeholders; Open Questions

**Guide Rule ID**: G9

**Problem**: Core flows rely on booking search and on referencing structured outputs from earlier steps (`{{step_N.field}}`), but the centralized contracts do not define the booking entities, booking search result shapes, or the canonical keys available for placeholder resolution. The spec even flags the booking search response format as unknown.

**Evidence**:

- Guide (G9): “**Check:** Are data shapes declared in `specs/contracts/` (or `specs/interfaces.md`) rather than scattered in multiple specs?” (`/Users/tianyi.li/Dev/agent-actions-mvp/./references/SPEC_GENERATION_GUIDE.md`)
- Spec (fuzzy search dependency): “Resolve booking reference (from chat context or via fuzzy search)” (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`)
- Spec (placeholder scheme): “`{{step_N.field}}` — Reference output from step N” (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`)
- Spec (known unknown): “What’s the exact format of booking search API response? (Needed for fuzzy search implementation)” (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`)

**Impact**: Implementation will either:
- Hardcode assumptions about booking fields/IDs (high rework risk), or
- Keep everything as `map[string, any]` and accept cross-module drift (integration failures).

**Suggested Fix**:

- Add booking domain contracts in `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` (or a new contracts file) for:
  - `BookingSummary` (minimum fields needed for fuzzy search + disambiguation)
  - `BookingSearchRequest` / `BookingSearchResponse`
  - Canonical placeholder keys available from each atomic action response (at least for the 3 MVP actions)

---

### Issue 4: The external interface to this service (chat request, plan confirmation, status polling/updates) is not specified

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Architecture Position (Data Flow); Cross-Module Interfaces

**Guide Rule ID**: G8

**Problem**: The design describes a user chat flow and integration with an existing intent classifier, but does not define the actual cross-boundary request/response contracts for:
- submitting a user message,
- returning a plan for confirmation,
- confirming/canceling a plan,
- retrieving execution status/results (polling or push).

The “Cross-Module Interfaces” section focuses on internal components and omits the service boundary interfaces that other teams/systems must implement against.

**Evidence**:

- Guide (G8): “**Check:** When a component interacts with others, does the spec declare what data is passed and when?” (`/Users/tianyi.li/Dev/agent-actions-mvp/./references/SPEC_GENERATION_GUIDE.md`)
- Spec (user chat flow described, no boundary contract): “User sends natural language request via chat” and “Plan Presenter formats plan for user confirmation” and “User confirms → plan enters Queue” (`/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`)

**Impact**: Implementers must guess endpoint shapes, idempotency rules, and status semantics, increasing integration and rework risk. It also makes acceptance criteria hard to verify end-to-end across service boundaries.

**Suggested Fix**:

- Add an explicit “Service Boundary API” section/spec defining:
  - request/response payloads (referencing centralized contracts),
  - auth propagation rules (including token handling),
  - idempotency (especially for confirm + execution),
  - error codes/messages, and
  - how status is retrieved/updated (poll vs push) for MVP.

---

## Summary

| ID | Issue | Severity | Location | Guide Rule | Status |
| --- | ------- | -------- | ----------------------- | ---------- | ------ |
| 1 | Langfuse tracing can leak PII/auth tokens without a required redaction contract | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G11 | Deferred |
| 2 | Execution can prompt the user mid-run, but plan lifecycle/state model has no “waiting for user” (and confirmation invariants become unclear) | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G10 | Open |
| 3 | Booking domain contracts are missing (blocking fuzzy search + placeholder resolution from being implementation-ready) | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Open |
| 4 | The external interface to this service (chat request, plan confirmation, status polling/updates) is not specified | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Open |

---

## Files Reviewed

- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/questions-and-answers.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`
