# Spec Verification Report

Verified by Codex on 2026-01-29.

---

## Summary
| ID | Issue | Severity | Location | Guide Rule | Status (Fixed/Partial/Missing/Declined/Declined-Accepted) | Notes |
|----|-------|----------|----------|------------|--------------------------------------------------|-------|
| 1 | Missing interface for answering `blocking_prompt` and resuming execution | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Partial | Resume interface added, but routing/ambiguity for multiple active plans per session is still underspecified. |
| 2 | Contradiction between “post-confirmation immutability” and executor “adjust sequence” | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G10 | Fixed | Executor self-correction clarified as parameter-level only within confirmed action sequence. |
| 3 | IQ integration request/response contracts are not centralized and error enums conflict with existing error types | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Partial | Added note distinguishing service- vs action-level error types, but boundary contracts remain inline (not centralized). |
| 4 | `ExecutionPlan.user_id` is required but the service interface does not supply it and token handling is “opaque” | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` | G8 | Fixed | `user_id` is now supplied by IQ on inbound interfaces; ownership precondition added for confirm/answer. |

## Detailed Findings

### Issue 1: Missing interface for answering `blocking_prompt` and resuming execution

**Severity**: Critical

**Status**: Partial

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration) > Inbound: Submit Blocking Prompt Answer

**Guide Rule ID**: G8

**Problem**: The resume interface is now defined, but routing remains ambiguous when there are multiple active plans in a session (or when the user sends a new request while a plan is blocked). The spec states IQ checks whether the session “has an active plan” with `blocking_prompt`, but does not constrain this to *at most one* or define disambiguation behavior when multiple plans qualify.

**Evidence**: “IQ determines whether a user message is a new request vs answer … by checking if session has an active plan in `executing` status with `blocking_prompt` set”.

**Impact**: IQ orchestration and the service may still diverge on which plan to resume, leading to misrouted answers, stuck executions, or incorrect continuation when multiple plans exist for the same session.

**Suggested Fix**: Add one of:
- An explicit invariant: “At most one plan per `session_id` may be `executing` with `blocking_prompt` set”; if violated, IQ must prompt the user to pick a plan or the service returns a conflict error with remediation text.
- Or explicit disambiguation rules (e.g., “resume most recently updated blocked plan”) and required fields IQ must send to make the choice unambiguous.

**What Changed**: Added `Inbound: Submit Blocking Prompt Answer` with inputs, preconditions (including `user_id` ownership), error cases, and a routing note for IQ.

**Assessment**: Mostly addressed, but still underspecified for multi-plan/session-level ambiguity.

**Remaining Work** (if any): Clarify single-active-blocked-plan invariant or define multi-plan routing/disambiguation rules.

### Issue 2: Contradiction between “post-confirmation immutability” and executor “adjust sequence”

**Severity**: Critical

**Status**: Fixed

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: Action Executor

**Guide Rule ID**: G10

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**: The executor contract now limits “self-correct” to parameter formatting/placeholder resolution/retry within the confirmed action sequence, removing the previous “adjust sequence” contradiction with post-confirmation immutability.

**Assessment**: Fully addressed

**Remaining Work** (if any): None

### Issue 3: IQ integration request/response contracts are not centralized and error enums conflict with existing error types

**Severity**: High

**Status**: Partial

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration) > Inbound: Handle Booking Update Request

**Guide Rule ID**: G9

**Problem**: The spec still defines the integration boundary response variants (plan vs clarification vs error) inline, and the service-level error enum remains inline. The added note reduces confusion but does not meet the “centralized contracts” requirement for shared boundary shapes, and it still leaves IQ↔service payload envelopes underspecified.

**Evidence**:
- “**Output:** One of: … Plan response … Clarification response … **Error response:** Service error type (enum: invalid_input / service_unavailable / auth_required) + message”
- “Note on error types: Service-level errors … Action-level errors … per [data-definitions.md]”

**Impact**: Boundary payload/type drift risk remains (especially as IQ integration evolves), and implementers must still guess how to represent the “one of” structure (envelope fields, discriminators, etc.) consistently across modules.

**Suggested Fix**: Centralize the boundary shapes in `specs/contracts/` (or `specs/interfaces.md`) using abstract, language-agnostic definitions:
- `BookingUpdateRequest` (at minimum: user_message, session_id, user_id, user_auth_token)
- `BookingUpdateResponse` (“one of”: plan / clarification / error) described as a union at the spec layer without prescribing a concrete discriminator encoding
- `ServiceErrorType` enum, plus a short mapping note clarifying service vs action error contexts

**What Changed**: Added a clarifying note distinguishing service-level error types from action-level errors, but did not move or define the boundary contracts in the centralized contracts document.

**Assessment**: Partially addressed; centralization and boundary contract clarity still missing.

**Remaining Work** (if any): Add centralized abstract request/response contracts for the IQ integration boundary.

### Issue 4: `ExecutionPlan.user_id` is required but the service interface does not supply it and token handling is “opaque”

**Severity**: High

**Status**: Fixed

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` > Section: Execution Plan

**Guide Rule ID**: G8

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**: The service interface now requires `user_id` on inbound calls (explicitly “provided by IQ from authenticated session”), and adds ownership validation preconditions where applicable (confirm and blocking-prompt answer).

**Assessment**: Fully addressed

**Remaining Work** (if any): None

## Feedback Review (if applicable)

### Issue 3: IQ integration request/response contracts not centralized
- **Implementer's Reasoning**: The enum conflict was addressed via a clarifying note; adding centralized union contracts and a separate `ServiceErrorType` would be “over-engineering” and would violate G1/G4 by prescribing implementation details.
- **Assessment**: Invalid
- **Response**:
  - Re-raised - Centralizing boundary shapes is explicitly required by G9 to prevent type drift, and can be done with abstract, language-agnostic tables (“one of” semantics) without introducing implementation code (G1) or language-specific dataclasses/interfaces (G4).

## New Issues (Regressions)

No new Guardrails G1–G11 violations were introduced by the v5 fixes.

## Completion Status

<promise>ISSUES_REMAINING</promise>

Remaining issue IDs: 1, 3

