# Spec Verification Report

Verified by Codex on 2026-01-30.

---

## Summary
| ID | Issue | Severity | Location | Guide Rule | Status (Fixed/Partial/Missing/Declined/Declined-Accepted) | Notes |
|----|-------|----------|----------|------------|--------------------------------------------------|-------|
| 1 | Langfuse tracing can leak PII/auth tokens without a required redaction contract | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G11 | Declined-Accepted | Human reviewer confirmed: existing Langfuse setup has data cleaning pipeline that handles PII/token redaction. |
| 2 | Execution can prompt the user mid-run, but plan lifecycle/state model has no “waiting for user” (and confirmation invariants become unclear) | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G10 | Partial | Execution “pauses while executing” is clarified, but no explicit state/substate to represent “awaiting user input” in the plan contract or interface. |
| 3 | Booking domain contracts are missing (blocking fuzzy search + placeholder resolution from being implementation-ready) | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Declined | Decline reasoning is not sufficient; internal normalized booking contracts are still required even if the external API is unknown. |
| 4 | The external interface to this service (chat request, plan confirmation, status polling/updates) is not specified | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Partial | “Service Interface (IQ Integration)” added, but boundary contracts remain underspecified (payloads/errors/cancel/status semantics). |

## Detailed Findings

### Issue 1: Langfuse tracing can leak PII/auth tokens without a required redaction contract

**Severity**: Critical

**Status**: Declined-Accepted

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Observability; Constraints > Security; Constraints > Privacy/PII

**Guide Rule ID**: G11

**Problem**: The specs still require rich tracing ("LLM call" prompt/response; "Tool call" parameters/response), while only stating "avoid logging raw PII" and "auth tokens never logged". There is no concrete, enforceable redaction/allowlist policy specifying what fields are permitted in Langfuse metadata, what must always be stripped/hashed, and how retention aligns across stores.

**Evidence**:

- Observability traces capture "LLM Call | Model, prompt, response…" and "Tool Call | Action ID, parameters, response…" (`specs/2026-01-29-booking-updates-design.md`, Observability > What Gets Traced).
- Privacy note is non-enforceable: "Langfuse traces may contain intent summaries; avoid logging raw PII in trace metadata" (`specs/2026-01-29-booking-updates-design.md`, Constraints > Privacy/PII).
- System-level privacy notes do not define redaction policy (denylist/allowlist) for traces (`specs/README.md`, Data Privacy / PII / Retention).

**Impact**: Implementers can still inadvertently attach guest PII and/or auth headers to traces, creating security/privacy incident risk and leaving logging behavior to guesswork.

**Suggested Fix**: Add an authoritative "Observability Redaction Policy" (in `specs/README.md` or `specs/2026-01-29-booking-updates-design.md`) defining:
- a denylist of sensitive keys/headers (e.g., `authorization`, `cookie`, `email`, `phone`, `token`, etc.),
- per-event allowlists for Langfuse metadata (LLM calls, tool calls, tool responses),
- what is logged in full vs summarized/hashed, and
- retention alignment statement for Langfuse vs session-scoped state.

**What Changed**: No changes detected (spec content remains the same; only the issue report includes a "Deferred" note).

**Human Reviewer Decision**: The existing Langfuse setup has a data cleaning pipeline that handles PII/token redaction. This infrastructure-level solution addresses the concern without requiring spec-level redaction policy definitions. Will revisit if the existing pipeline proves insufficient for this service's tracing needs.

**Assessment**: Accepted as resolved via existing infrastructure.

**Remaining Work** (if any): None — deferred to existing Langfuse data cleaning pipeline.

### Issue 2: Execution can prompt the user mid-run, but plan lifecycle/state model has no “waiting for user” (and confirmation invariants become unclear)

**Severity**: Critical

**Status**: Partial

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: Action Executor > Execute Plan; State Model > Invariants

**Guide Rule ID**: G10

**Problem**: The spec now states execution can “pause until user responds” while remaining in `executing`, and adds an invariant that the confirmed plan cannot be structurally modified post-confirmation. However, the plan lifecycle still lacks a first-class way (status/substatus/fields) to represent “awaiting user input” for downstream systems. This keeps “what the user sees” and “how orchestration resumes” underspecified.

**Evidence**:

- “Execution pauses until user responds (plan remains in `executing` status)” (`specs/2026-01-29-booking-updates-design.md`, Action Executor > Execute Plan).
- Invariant clarifies post-confirmation mutation limits (`specs/2026-01-29-booking-updates-design.md`, State Model > Invariants).
- Central contract still has no explicit “awaiting user input” plan status (`specs/contracts/data-definitions.md`, Enums > Plan Status).

**Impact**: IQ/orchestration cannot reliably distinguish “actively executing” vs “blocked on user input”, which affects UX (status display), timeouts, and resume logic. This is a residual lifecycle ambiguity under G10.

**Suggested Fix**: Choose one minimal approach and document it end-to-end:
- Add a new plan status (e.g., `awaiting_user_input`) with transitions and invariants, or
- Keep `executing` but add explicit fields to `ExecutionPlan` (e.g., `blocking_reason`, `awaiting_user_input`, `pending_question`, `last_progress_at`) plus constraints on when they are set/cleared.

**What Changed**: Added execution pause behavior and post-confirmation invariants in `specs/2026-01-29-booking-updates-design.md`.

**Assessment**: Partially addressed; still missing a contract/interface representation for “awaiting user input”.

**Remaining Work** (if any): Define the user-input-wait representation in centralized contracts and reference it from the service interface/status retrieval flow.

### Issue 3: Booking domain contracts are missing (blocking fuzzy search + placeholder resolution from being implementation-ready)

**Severity**: High

**Status**: Declined

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: LLM Planner > Plan Generation; Data Placeholders; Open Questions

**Guide Rule ID**: G9

**Problem**: Booking entity/search contracts and canonical placeholder keys remain undefined in centralized contracts. This still blocks implementation readiness for fuzzy search and placeholder resolution across steps.

**Evidence**:

- The spec explicitly treats booking search response format as unknown (`specs/2026-01-29-booking-updates-design.md`, Open Questions).
- Central contracts contain no booking domain entities and still use `map[string, any]` for `parameters` and `response_data` (`specs/contracts/data-definitions.md`).

**Impact**: Cross-module drift risk remains high: implementers will either guess booking fields/IDs or keep everything untyped/loosely typed, undermining the “centralized contracts” architecture and making placeholder resolution fragile.

**Suggested Fix**: Define internal, normalized booking contracts in `specs/contracts/` that are explicitly “this service’s view” (not the external ROLLER API), e.g.:
- `BookingCandidate`/`BookingSummary` (minimum fields for disambiguation),
- `BookingSearchQuery` and `BookingSearchResult` (normalized shape produced by an adapter over the external API),
- a canonical placeholder key inventory for each MVP atomic action’s `response_data` (even if values are sourced from external APIs).

**What Changed**: Declined by implementer.

**Assessment**: See Feedback Review.

**Remaining Work** (if any): Re-raised: add internal normalized contracts (or provide revised rationale plus an alternative that still satisfies G9).

### Issue 4: The external interface to this service (chat request, plan confirmation, status polling/updates) is not specified

**Severity**: High

**Status**: Partial

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration)

**Guide Rule ID**: G8

**Problem**: The new “Service Interface (IQ Integration)” section improves the boundary definition, but it remains too high-level to fully satisfy cross-module interface declaration requirements: it does not define concrete request/response payload shapes (referencing centralized contracts), error behaviors, cancellation semantics, and the polling/push MVP choice.

**Evidence**:

- Inputs/outputs are described generically (e.g., “User message, chat session context, user auth token”; “clarification question”; “error”) without a centralized contract reference for those payloads (`specs/2026-01-29-booking-updates-design.md`, Service Interface).
- “Outbound: Status Updates” leaves mechanism TBD, and there is no explicit “Cancel Plan” interface (Issue 4 explicitly called out confirm/cancel) (`specs/2026-01-29-booking-updates-design.md`, Service Interface).

**Impact**: Integration teams still need to guess payload formats, error handling expectations, and how status updates are delivered, increasing rework risk and making end-to-end acceptance criteria hard to validate across the integration boundary.

**Suggested Fix**: Add a minimal set of boundary contracts (still behavioral, but concrete data shapes) referencing `specs/contracts/data-definitions.md`, for example:
- `HandleBookingUpdateRequest` input shape (message + session context + auth propagation),
- `HandleBookingUpdateResponse` union: `{plan}` vs `{clarification_question}` vs `{error}`,
- `ConfirmPlanRequest/Response` and `GetPlanStatusResponse` (including how to represent “awaiting user input” per Issue 2),
- Either add “Cancel Plan” interface or explicitly defer it in `specs/README.md` Scope (so consumers know it is not supported in MVP/SLC).

**What Changed**: Added “Service Interface (IQ Integration)” section in `specs/2026-01-29-booking-updates-design.md`.

**Assessment**: Partially addressed; boundary is clearer, but interface contracts remain incomplete for integration.

**Remaining Work** (if any): Add minimal concrete payload/error/cancel semantics, tied back to centralized contracts.

## Feedback Review (if applicable)

### Issue 1: Langfuse PII/token redaction
- **Human Reviewer's Decision**: Existing Langfuse setup has a data cleaning pipeline that handles PII/token redaction.
- **Assessment**: Valid — infrastructure-level solution addresses the concern.
- **Response**: Accepted. The existing data cleaning pipeline provides the redaction guarantees at the infrastructure level. No spec-level policy required unless the pipeline proves insufficient.

### Issue 3: Booking domain contracts are missing
- **Implementer's Reasoning**: ROLLER booking search API is external and its response shape is unknown/owned by ROLLER; defining contracts here would be speculative and risk drift; specs should not over-specify external dependencies.
- **Assessment**: Invalid
- **Response**:
  - Re-raised - This spec set still needs internal, normalized contracts that *this service* depends on (e.g., “minimum booking disambiguation fields”, normalized search results, and canonical placeholder keys). These can be explicitly defined as post-adapter shapes without claiming the external API’s raw response format, satisfying G9 while avoiding over-specifying ROLLER.

## New Issues (Regressions)

None detected in the applied fixes (no new G1–G11 violations introduced beyond the remaining gaps tracked above).

## Completion Status

<promise>ISSUES_REMAINING</promise>
- Remaining issue IDs: 2, 3, 4
