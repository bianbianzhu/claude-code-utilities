# Spec Verification Report

Verified by Codex on 2026-01-29.

---

## Summary
| ID | Issue | Severity | Location | Guide Rule | Status (Fixed/Partial/Missing/Declined/Declined-Accepted) | Notes |
|----|-------|----------|----------|------------|------------------------------------------------------------|-------|
| 1 | Get Plan Status Missing AuthZ Context (IDOR Risk) | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Fixed | “Get Plan Status” now includes `user_id` + auth token + ownership precondition + auth error cases. |
| 2 | Queue Failure Recovery Contradicts Confirm Plan Idempotency and State Model | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G10 | Partial | Queue failure behavior clarified, but Confirm Plan + state transition text still leaves ambiguity about when status becomes `confirmed` and how enqueue failures surface at the inbound boundary. |
| 3 | Metadata Overlay Field Name Drift vs Central Contract | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Fixed | `iq_enabled` is now consistent between design spec prose and centralized contract. |
| 4 | Central Contract Type System Is Internally Inconsistent (`time` Undefined) | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` | Checklist (Type sufficiency) | Partial | `time` added to primitive enum and one field constraint added, but canonical `time` representation remains under-specified for general use (esp. ActionParameter `type=time`). |

## Detailed Findings

### Issue 1: Get Plan Status Missing AuthZ Context (IDOR Risk)

**Severity**: Critical

**Status**: Fixed

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration) → Inbound: Get Plan Status

**Guide Rule ID**: G8

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**:
- “Get Plan Status” now requires `plan_id`, `user_id`, and user auth token; includes ownership precondition (`user_id` matches plan creator).
- Added auth-related error cases (401/403) plus not-found (404).

**Assessment**: Fully addressed

**Remaining Work** (if any): None

---

### Issue 2: Queue Failure Recovery Contradicts Confirm Plan Idempotency and State Model

**Severity**: High

**Status**: Partial

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Cross-Module Interfaces → LLM Planner → Queue Manager; Service Interface (IQ Integration) → Inbound: Confirm Plan; State Model

**Guide Rule ID**: G10

**Problem**: The spec clarifies that queue insertion failure keeps the plan in `pending_confirmation`, but the Confirm Plan inbound contract and the state transition diagram still imply an unconditional `pending_confirmation → confirmed` transition on “user confirms”, and Confirm Plan does not declare how enqueue failures are returned at the inbound boundary (error shape/status) without implementers guessing.

**Evidence**:
- Cross-module interface now states:
  > “If queue insertion fails, plan status remains `pending_confirmation`, failure is reported to user, and user may re-confirm (which re-attempts enqueue)”
- Confirm Plan inbound still states:
  > “transitions plan status to `confirmed`; enters execution queue”
- State model still labels the transition as:
  > “user confirms” (with an invariant of no `pending_confirmation → confirmed → pending_confirmation`)

**Impact**: Implementers still have to guess (a) whether “Confirm Plan” persists `confirmed` before enqueue ack, (b) what error response to return on enqueue failure (and whether to return `ExecutionPlan` or `ServiceError`), and (c) the intended idempotency/dedup behavior for repeated confirm attempts while still `pending_confirmation`.

**Suggested Fix**:
- Update “Inbound: Confirm Plan” to explicitly cover the enqueue failure path:
  - On enqueue success: persist status → `confirmed` (set `confirmed_at`) and return `ExecutionPlan`.
  - On enqueue failure: keep status `pending_confirmation` and return a defined error response (e.g., `ServiceError` with `service_unavailable`), or return `ExecutionPlan` + a defined failure indicator (if that is preferred).
- Update the state model transition label to be conditional (e.g., “user confirms + enqueue succeeds”), and add a brief note about confirm retry semantics while still `pending_confirmation`.
- Align “LLM Planner → Queue Manager” “Data passed” with the intended status at the moment of queue insertion (or clarify that the queued payload uses `confirmed` but persistence is only after enqueue ack).

**What Changed**: Updated only the “LLM Planner → Queue Manager” error handling text to keep status `pending_confirmation` on queue insertion failure; Confirm Plan and the state transition diagram were not updated to reflect conditionality and inbound error semantics.

**Assessment**: Partially addressed — state/contract ambiguity remains around enqueue failure and the Confirm Plan boundary.

**Remaining Work** (if any): Update Confirm Plan + state model to explicitly define the conditional transition and the enqueue-failure response semantics.

---

### Issue 3: Metadata Overlay Field Name Drift vs Central Contract

**Severity**: High

**Status**: Fixed

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: Action Transformer → Transformation Rules

**Guide Rule ID**: G9

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**: Standardized the metadata key in prose from `iq-enabled` to `iq_enabled`, matching the canonical contract in `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`.

**Assessment**: Fully addressed

**Remaining Work** (if any): None

---

### Issue 4: Central Contract Type System Is Internally Inconsistent (`time` Undefined)

**Severity**: High

**Status**: Partial

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` > Section: Action Parameter; Booking Summary

**Guide Rule ID**: Checklist item — “Data definitions are sufficient to generate shared types during planning phase”

**Problem**: The contract now includes `time` in the ActionParameter primitive type enum and adds a constraint for `BookingSummary.booking_time`, but the canonical representation for the `time` primitive is still not explicitly defined in one place (format, seconds support, timezone semantics). This keeps the planning layer/spec consumer in a guessy state for any ActionParameter declared as `type=time` beyond this one field.

**Evidence**:
- ActionParameter type enum now includes `time`, but without a corresponding canonical definition of `time`’s format:
  > “string / number / boolean / date / datetime / time / enum”
- Only one specific field constrains it:
  > “booking_time | time | … | HH:MM local venue time”

**Impact**: Type generation and validation for action parameters (and future `time` fields) can still drift (some treating as string, others as datetime), creating serialization/validation inconsistencies across modules.

**Suggested Fix**:
- Add a canonical definition for the `time` primitive (single source of truth), e.g.:
  - Represented as `string` with constraint `HH:MM` (optionally `HH:MM:SS`), and explicitly state whether it is local venue time or requires an offset.
- Reference that canonical definition from fields using `time` (instead of repeating per-field constraints unless it genuinely differs).

**What Changed**: Added `time` to the ActionParameter primitive type enum and added “HH:MM local venue time” constraint to `BookingSummary.booking_time`.

**Assessment**: Partially addressed — the immediate inconsistency is reduced, but the primitive type still lacks a centralized definition usable by planning/type generation.

**Remaining Work** (if any): Add a canonical `time` primitive definition (format + timezone semantics) to make type generation unambiguous.

## Feedback Review (if applicable)

No feedback file present at `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/issues/2026-01-30-v12-feedback.md`.

## New Issues (Regressions)

No new Guardrails G1–G11 violations introduced by the applied fixes were detected.

## Completion Status

<promise>ISSUES_REMAINING</promise>

Remaining issue IDs: 2, 4

