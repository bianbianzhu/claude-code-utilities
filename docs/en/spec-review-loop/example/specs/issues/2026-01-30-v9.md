# Spec Review: Thresholded Issues

Identified by Codex analysis on 2026-01-29.

---

## Critical Issues

### Issue 1: Booking search / fuzzy match data contract missing (blocks core flow)

**Severity**: Critical

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: LLM Planner

**Guide Rule ID**: G8

**Problem**: The MVP requires resolving a booking via “fuzzy search” and presenting multiple matches for user selection, but the data returned by the booking search capability is explicitly unknown and not specified anywhere in the centralized contracts. This blocks implementing the core “resolve booking reference” behavior and any contract tests around it.

**Evidence**:

Spec text:

> **LLM Planner → Plan Generation**: “Resolve booking reference (from chat context or via **fuzzy search**)”
>
> **Failure Modes & Strategies**: “Multiple bookings match … **Present list of matches**; ask user to select specific booking”
>
> **Open Questions**: “What’s the exact format of **booking search API response**? (Needed for fuzzy search implementation)”

Guide rule text:

> **G8 — Cross-Module Interfaces Declared**
>
> **Check:** “When a component interacts with others, does the spec declare what data is passed and when?”

**Impact**: Implementers must guess the booking search response shape and which fields are available/stable (booking identifiers, names, start time, contact info, status, etc.). This is likely to cause rework and cross-module type drift once the real ROLLER API response is known.

**Suggested Fix**:

- Define an abstract contract in `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` for:
  - `BookingSearchQuery` (inputs used for fuzzy search)
  - `BookingSearchResult` / `BookingSummary` (minimum fields required to disambiguate and to drive downstream actions, including the canonical `booking_id`)
- In the design spec, update the Planner contract to reference these types and define selection UX/data (e.g., how many candidates returned, what fields are displayed, and how user selection maps back to `booking_id`).

---

## High Priority Issues

### Issue 2: Missing centralized contracts for service boundary responses and metadata overlay

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration)

**Guide Rule ID**: G9

**Problem**: The spec defines service-level response shapes (plan vs clarification vs error) and a required “metadata overlay” input, but these shapes are not centralized in `specs/contracts/`. This creates cross-spec and cross-module drift risk (IQ integration boundary, action transformation pipeline).

**Evidence**:

Spec text:

> **Inbound: Handle Booking Update Request → Output**: “One of: **Plan response** … **Clarification response** … **Error response:** Service error type (enum: invalid_input / service_unavailable / auth_required) + message”
>
> **Component: Action Transformer → Metadata Overlay**: “Each action requires a **metadata overlay** that enhances the raw OpenAPI definition”

Guide rule text:

> **G9 — Centralized Contracts**
>
> **Check:** “Are data shapes declared in `specs/contracts/` (or `specs/interfaces.md`) rather than scattered in multiple specs?”

**Impact**: IQ integration implementers and the booking-update service implementers can diverge on payload shapes and error semantics (especially around clarification vs plan vs error), causing integration failures late. Similarly, the action transformer cannot be implemented consistently without a defined overlay schema.

**Suggested Fix**:

- Add centralized types to `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`:
  - `ServiceError` (including the `service_error_type` enum and constraints)
  - `HandleBookingUpdateResponse` as a discriminated union (plan / clarification / error)
  - `ActionMetadataOverlay` (fields, constraints, and how it maps to `AtomicAction`)
- Update the design spec to reference these contracts instead of redefining response shapes in prose.

---

### Issue 3: Retry/attempt behavior is inconsistent and uses hardcoded counts

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: LLM Planner

**Guide Rule ID**: G3

**Problem**: The specs say “no auto-retry from this service” while also stating that the executor may “retry failed steps”, and they hardcode numeric attempt limits (clarification attempts). This mixes behavioral requirements with concrete “knob values” and leaves implementers guessing which errors can be retried (and how) without violating the “no auto-retry” requirement.

**Evidence**:

Spec text:

> **Planning Rules**: “If intent is completely unclear after **2 clarification attempts**, suggest user rephrase…”
>
> **Action Executor → Execute Plan**: “LLM can self-correct … **retry failed steps**”
>
> **Failure Modes & Strategies**: “Rate limit hit (429) … report ‘retry in X seconds’; **no auto-retry**”
>
> `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md` > **Explicitly Deferred**: “**Auto-retry** from this service”

Guide rule text:

> **G3 — No Concrete Config Values**
>
> **Check:** “Does the spec hardcode timeout durations, pool sizes, retry counts, etc.?”

**Impact**: Implementers may add retries that violate intended UX (unexpected repeated mutations) or violate the deferred-scope constraint. Hardcoded attempt limits also reduce product flexibility and can force rework when behavior tuning is needed.

**Suggested Fix**:

- Define a **retry policy matrix** by `Error Type` (in terms of allowed/forbidden retry and what qualifies as “self-correction” vs “retry”).
- Replace hardcoded attempt counts with constraints (e.g., “bounded small number, configurable”) unless product explicitly requires a fixed value.
- Clarify that retries, if any, are limited to safe, non-mutating replays or parameter-format corrections (e.g., only for 400 due to formatting), and are disallowed for 429/5xx/timeouts.

---

### Issue 4: `action_id` constraints contradict “matches OpenAPI operationId”

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` > Section: Atomic Action

**Guide Rule ID**: Checklist — Glossary / Canonical Definitions

**Problem**: `action_id` is simultaneously constrained as `snake_case` and described as “matching OpenAPI operationId”. Operation IDs are not guaranteed to be snake_case, and the spec does not define a normalization/mapping rule. This is an internal contract inconsistency that can cause broken references (e.g., `compensation_action_id`) and mismatched tool naming.

**Evidence**:

Spec text:

> **Atomic Action**: `action_id` constraints: “unique, **snake_case**”
>
> **Atomic Action**: `action_id` description: “Identifier **matching OpenAPI operationId**”

Guide rule text:

> **Glossary / Canonical Definitions**
>
> “Define shared terms, status values, and canonical field names.”

**Impact**: The Action Transformer cannot implement stable identifiers without guessing, and downstream references (`compensation_action_id`, plan actions referencing `action_id`) can drift if different components normalize IDs differently.

**Suggested Fix**:

- Choose one canonical rule and encode it in the contract:
  - Option A: `action_id` is exactly the OpenAPI `operationId` (remove `snake_case` constraint), or
  - Option B: `action_id` is normalized to snake_case and add `source_operation_id` (or equivalent) to preserve traceability.
- Update all references (`compensation_action_id`, planning/execution contracts) to use the canonical rule.

---

## Summary

| ID  | Issue | Severity | Location | Guide Rule | Status |
| --- | ----- | -------- | -------- | ---------- | ------ |
| 1 | Booking search / fuzzy match data contract missing (blocks core flow) | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Open |
| 2 | Missing centralized contracts for service boundary responses and metadata overlay | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Open |
| 3 | Retry/attempt behavior is inconsistent and uses hardcoded counts | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G3 | Open |
| 4 | `action_id` constraints contradict "matches OpenAPI operationId" | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` | Checklist — Glossary / Canonical Definitions | Open |

---

## Files Reviewed

Checklist of specs reviewed (from `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md`):

- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/questions-and-answers.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`
