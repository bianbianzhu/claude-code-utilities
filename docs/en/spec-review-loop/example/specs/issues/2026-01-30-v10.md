# Spec Verification Report

Verified by Codex on 2026-01-30.

---

## Summary

| ID | Issue | Severity | Location | Guide Rule | Status (Fixed/Partial/Missing/Declined/Declined-Accepted) | Notes |
|----|-------|----------|----------|------------|--------------------------------------------------|-------|
| 1 | Booking search / fuzzy match data contract missing (blocks core flow) | Critical | `specs/2026-01-29-booking-updates-design.md` | G8 | Fixed | Added centralized `BookingSearchQuery` + `BookingSummary` contracts and a booking resolution flow referencing them. |
| 2 | Missing centralized contracts for service boundary responses and metadata overlay | High | `specs/2026-01-29-booking-updates-design.md` | G9 | Partial | `ActionMetadataOverlay` + `ServiceErrorType` centralized, but the service boundary response payloads remain prose-only (no centralized response/error shape). |
| 3 | Retry/attempt behavior is inconsistent and uses hardcoded counts | High | `specs/2026-01-29-booking-updates-design.md` | G3 | Fixed | Removed hardcoded clarification attempt count; clarified “re-attempt” only for correctable issues and kept “no auto-retry” for 429. |
| 4 | `action_id` constraints contradict "matches OpenAPI operationId" | High | `specs/contracts/data-definitions.md` | Checklist — Glossary / Canonical Definitions | Fixed | `action_id` no longer constrained to `snake_case`; now explicitly preserves OpenAPI `operationId` format. |

## Detailed Findings

### Issue 1: Booking search / fuzzy match data contract missing (blocks core flow)

**Severity**: Critical

**Status**: Fixed

**Location**: `specs/2026-01-29-booking-updates-design.md` > Section: Booking Resolution Flow

**Guide Rule ID**: G8

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**:

- Added a “Booking Resolution Flow” describing when fuzzy search occurs and how multiple matches are presented (and selected) via centralized contract references.
- Added centralized contracts in `specs/contracts/data-definitions.md`:
  - `BookingSearchQuery` (fuzzy search input)
  - `BookingSummary` (minimum disambiguation fields; includes canonical `booking_id`)

**Assessment**: Fully addressed

**Remaining Work** (if any): None

---

### Issue 2: Missing centralized contracts for service boundary responses and metadata overlay

**Severity**: High

**Status**: Partial

**Location**: `specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration)

**Guide Rule ID**: G9

**Problem**: The “Handle Booking Update Request” output still defines the service boundary payload shapes only in prose (“One of: plan / clarification / error”), and the centralized contracts still do not define a single authority shape for:

- The service-level error payload (type + message)
- The overall service response envelope / discriminant semantics

This leaves a remaining cross-module drift risk at the IQ integration boundary.

**Evidence**:

- The service output remains prose-defined:
  - “**Output:** One of: … **Plan response** … **Clarification response** … **Error response:** Service error type … + message” in `specs/2026-01-29-booking-updates-design.md`.
- `specs/contracts/data-definitions.md` now includes `ActionMetadataOverlay` and `ServiceErrorType`, but still has no centralized `ServiceError` (type + message) and no centralized `HandleBookingUpdateResponse` (or equivalent) contract.

**Impact**: IQ integration and service implementation can diverge on response schema (e.g., discriminant naming, field presence, error payload fields), creating late integration failures and type drift.

**Suggested Fix**:

- Add centralized, language-agnostic contracts to `specs/contracts/data-definitions.md`:
  - `ServiceError` (fields: `service_error_type` enum, `message`, optional `details`/`retry_after_seconds` if needed)
  - `HandleBookingUpdateResponse` (explicit “one-of” semantics captured as a table: a `response_kind` enum + optional fields, or separate tables with a shared discriminant field)
- Update `specs/2026-01-29-booking-updates-design.md` to reference these contracts instead of defining the service boundary shapes in prose.

**What Changed**: Added `ActionMetadataOverlay` and `ServiceErrorType` to centralized contracts; added spec references to these contracts. The service boundary response payloads remain un-centralized.

**Assessment**: Partially addressed; the remaining G9 gap is still material at the IQ boundary.

**Remaining Work** (if any): Centralize the service response + service error payload shapes and reference them from the design spec.

---

### Issue 3: Retry/attempt behavior is inconsistent and uses hardcoded counts

**Severity**: High

**Status**: Fixed

**Location**: `specs/2026-01-29-booking-updates-design.md` > Section: Planning Rules; Component: Action Executor

**Guide Rule ID**: G3

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**:

- Replaced the hardcoded “2 clarification attempts” with “bounded clarification attempts (configurable, small number)” in Planning Rules and failure handling.
- Tightened executor language from “retry failed steps” to “re-attempt steps that failed due to correctable issues (e.g., 400 from bad format)”.
- Preserved “no auto-retry from this service” behavior for 429 in Error Classification.

**Assessment**: Fully addressed

**Remaining Work** (if any): None

---

### Issue 4: `action_id` constraints contradict "matches OpenAPI operationId"

**Severity**: High

**Status**: Fixed

**Location**: `specs/contracts/data-definitions.md` > Section: Atomic Action

**Guide Rule ID**: Checklist — Glossary / Canonical Definitions

**Problem**: Resolved

**Evidence**: Resolved

**Impact**: None

**Suggested Fix**: N/A

**What Changed**: Updated `Atomic Action.action_id` constraints to remove `snake_case` and explicitly preserve the source OpenAPI `operationId` format (eliminates internal inconsistency and stabilizes downstream references like `compensation_action_id`).

**Assessment**: Fully addressed

**Remaining Work** (if any): None

## Feedback Review (if applicable)

### Issue 2 (Partial): HandleBookingUpdateResponse as Discriminated Union

- **Implementer's Reasoning**: Rejected creating a discriminated union because it is “language-specific”; argued the existing prose “One of:” is sufficient and specs should not dictate type-system constructs.
- **Assessment**: Invalid
- **Response**: Re-raised — this can be expressed language-agnostically as a centralized contract (e.g., `response_kind` enum + optional fields, or separate response tables sharing a discriminator). The G9 risk (cross-module drift) remains without a single authoritative shape in `specs/contracts/`.

### Issue 3 (Partial): Retry Policy Matrix

- **Implementer's Reasoning**: Rejected adding a separate retry policy matrix because Error Classification already defines behavior per error type; a matrix would duplicate content and risk drift.
- **Assessment**: Valid
- **Response**: Accepted - removed from tracking (the clarified behavioral text + Error Classification are sufficient without introducing duplicative tables).

## New Issues (Regressions)

No new Guardrails G1–G11 violations were introduced by the applied fixes.

## Completion Status

<promise>ISSUES_REMAINING</promise>

Remaining issue IDs: 2

