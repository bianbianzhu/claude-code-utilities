# Spec Review: Thresholded Issues

Identified by Codex analysis on January 29, 2026.

---

## Critical Issues

### Issue 1: Executor tool-call allowlist not specified (confirmation bypass risk)

**Severity**: Critical

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: Action Executor

**Guide Rule ID**: G8

**Problem**: The spec states that users confirm a plan once and that no new actions are added during execution, but it does not define a concrete cross-module contract/constraint that enforces “the executor may only call the tools corresponding to the confirmed plan’s `actions[].action_id`”. Because the executor is explicitly LLM-driven tool-calling, leaving this enforcement implicit creates a security and correctness gap: the LLM could invoke any available atomic action (including high-risk actions) even if it was not part of the confirmed plan.

**Evidence**:

- Spec:
  - “**Act:** LLM calls tool (atomic action wrapped as LangChain tool)”
  - “Only missing data within the confirmed intent may be requested (**no new actions added**)”
  - “All mutations require user confirmation”
- Guide (G8):
  - “**G8 — Cross-Module Interfaces Declared**”
  - “**Check:** When a component interacts with others, does the spec declare what data is passed and when?”

**Impact**: Without an explicit allowlist contract and server-side enforcement, an LLM/tooling bug or prompt injection could result in unconfirmed mutations (auth-bypass-like behavior at the confirmation boundary). This also makes it hard to write contract tests that prove “confirm once” is actually enforced.

**Suggested Fix**:

- Add an explicit executor constraint: only expose/permit tool calls whose `action_id` appears in the confirmed `ExecutionPlan.actions[]` (plus any explicitly allowed read-only helper tools, if needed).
- Define how enforcement works (e.g., “tool router validates `action_id` against plan allowlist; non-allowlisted tool calls are rejected and treated as execution failure”).
- Clarify how `safety_tier: blocked` actions are handled end-to-end (e.g., never registered as executable tools, or always filtered out before tool exposure).

---

### Issue 2: Observability spec risks capturing PII/auth tokens in traces without a redaction contract

**Severity**: Critical

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Observability

**Guide Rule ID**: G11

**Problem**: The spec says auth tokens are never logged and that PII is not stored, but it also requires tracing full LLM prompts/responses and tool call parameters/responses. Those payloads can naturally contain guest email/phone and potentially auth tokens (e.g., if included in prompts, tool payloads, or error messages). The spec only mentions avoiding PII in “trace metadata”, which is not sufficient if the primary traced content includes PII.

**Evidence**:

- Spec:
  - “Auth tokens passed through, **never logged or persisted**”
  - “LLM Call | Model, **prompt, response**, latency, tokens used | …”
  - “All LLM calls traced to Langfuse with **prompt, response**, latency, tokens”
  - “Langfuse traces may contain intent summaries; **avoid logging raw PII in trace metadata**”
- Guide (G11):
  - “**G11 — Privacy/PII/Retention Defined**”
  - “**Check:** If the component handles user data, are sensitivity, redaction, and retention rules stated?”

**Impact**: High likelihood of PII exposure in observability tooling (Langfuse) and/or accidental token leakage if any token-bearing data is captured. This is a security/compliance risk and can violate internal data handling requirements even if the service itself does not persist PII.

**Suggested Fix**:

- Define a concrete redaction policy/contract for traces (what fields are allowed, what must be redacted/hardened, and where redaction occurs).
- Explicitly state that auth tokens must never appear in LLM prompts, tool call logs, or trace payloads; pass tokens out-of-band and ensure tracing middleware scrubs headers/secrets.
- Specify retention/access controls for trace content containing user messages (including whether prompts/responses are stored, and if so under what retention policy and redaction).

---

### Issue 3: Library-specific references in the spec violate the “no library-specific APIs” guardrail

**Severity**: Critical

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Component: Action Executor

**Guide Rule ID**: G2

**Problem**: The spec uses library-specific naming for the execution mechanism (e.g., “LangChain tool”), which can lock the implementation to a specific framework and becomes stale as APIs evolve. The guide requires dependency declarations in capability terms rather than library/class identifiers.

**Evidence**:

- Spec:
  - “**Act:** LLM calls tool (**atomic action wrapped as LangChain tool**)”
  - “**Framework:** LangGraph / LangChain ecosystem”
- Guide (G2):
  - “**G2 — No Library-Specific APIs**”
  - “**Check:** Does the spec reference specific library class names, method names, or constructor parameters?”

**Impact**: Increases the risk of copy-paste implementation coupling, and forces later rework if the runtime/tooling choice changes (or if internal wrappers diverge from upstream APIs).

**Suggested Fix**:

- Replace library/class phrasing with capability-based language (e.g., “tool-calling runtime” / “agent orchestration runtime supporting ReAct and tool invocation”).
- Keep framework choices (LangGraph/LangChain) only in non-authoritative context sections and ensure the behavioral contract does not depend on them.

---

## High Priority Issues

### Issue 4: IQ integration boundary lacks a centralized request/response envelope contract

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` > Section: Service Interface (IQ Integration)

**Guide Rule ID**: G9

**Problem**: The integration boundary describes multiple possible output types (plan vs clarification string vs error), but there is no centralized, discriminated contract for these responses in `/specs/contracts/`. This invites cross-module drift and forces implementers to invent an envelope shape and error mapping during implementation.

**Evidence**:

- Spec:
  - “**Output:** One of:”
  - “**Plan response:** ExecutionPlan …”
  - “**Clarification response:** Question text (string) …”
  - “**Error response:** ServiceError …”
- Guide (G9):
  - “**G9 — Centralized Contracts**”
  - “**Check:** Are data shapes declared in `specs/contracts/` (or `specs/interfaces.md`) rather than scattered in multiple specs?”

**Impact**: IQ orchestrator integration is likely to require rework (or brittle ad-hoc parsing) because callers need a stable, testable envelope to route UI and conversation flows deterministically.

**Suggested Fix**:

- Add centralized contracts for the boundary in `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` (or a new contracts file), e.g.:
  - `BookingUpdateRequest`
  - `BookingUpdateResponse` as a discriminated union (`type: plan | clarification | error`) with a single top-level shape
  - Explicit error/code mapping for boundary errors (separate from action-level errors)

---

### Issue 5: Failure/rollback terminal state semantics are ambiguous across contracts and state model

**Severity**: High

**Status**: Open

**Location**: `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` > Section: Enums > Plan Status

**Guide Rule ID**: G10

**Problem**: The spec allows rollback attempts to partially fail (“continue on rollback failure”), but the `Plan Status` enum defines `rolled_back` as “rollback completed” without clarifying whether “completed” includes partial rollback with some compensation failures. The state model also shows `failed → rolled_back` after “rollback attempted”, which doesn’t specify when to remain `failed` vs transition to `rolled_back`.

**Evidence**:

- Spec:
  - “rolled_back | **Execution failed and rollback completed**”
  - “**Continue on rollback failure:** If one compensation fails, still attempt others”
- Guide (G10):
  - “**G10 — State Transitions Defined**”
  - “**Check:** If the component has lifecycle/status/state, are valid transitions and invariants explicitly documented?”

**Impact**: Clients (and operators) cannot reliably interpret terminal outcomes, which affects UX messaging, monitoring, and follow-up actions. It also makes it hard to write deterministic tests for rollback behavior.

**Suggested Fix**:

- Define explicit semantics for terminal statuses:
  - Option A: Always transition to `rolled_back` after rollback attempt finishes (even if partial), and encode partial failures in `rollback_report.actions_failed_to_reverse`.
  - Option B: Add/rename statuses (e.g., `rollback_partial` / `rollback_failed`) and specify invariants for each.
- Align the state model diagram/invariants and the contract enum meanings accordingly.

---

## Summary

| ID | Issue | Severity | Location | Guide Rule | Status |
| --- | ------- | -------- | ----------------------- | ---------- | ------ |
| 1 | Executor tool-call allowlist not specified (confirmation bypass risk) | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G8 | Open |
| 2 | Observability spec risks capturing PII/auth tokens in traces without a redaction contract | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G11 | Open |
| 3 | Library-specific references in the spec violate the “no library-specific APIs” guardrail | Critical | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G2 | Open |
| 4 | IQ integration boundary lacks a centralized request/response envelope contract | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md` | G9 | Open |
| 5 | Failure/rollback terminal state semantics are ambiguous across contracts and state model | High | `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md` | G10 | Open |

---

## Files Reviewed

Checklist of specs reviewed (generated from README.md and authoritative contracts):

- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/README.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/questions-and-answers.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/2026-01-29-booking-updates-design.md`
- [x] `/Users/tianyi.li/Dev/agent-actions-mvp/./specs/contracts/data-definitions.md`
